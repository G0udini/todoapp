{% extends 'base/main.html' %}
{% load static %}
{% block title %}Список задач{% endblock title %}

{% block content %}

<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<div class="header-bar">
    <div>
        <h1>{{ request.user|title }}</h1>
        <h3 style="margin:0">Колличество незаконченных задач: {{ count }}</h3>
    </div>

    {% if request.user.is_authenticated %}
        <a href="{% url 'logout' %}"><b>Выйти</b></a>
    {% else %}
        <a href="{% url 'login' %}"><b>Войти</b></a>
    {% endif %}
</div>

<div class="container-body">
    <div id="search-add-wrapper">
        <form method="GET" style="display: flex;">
            <input id="search-field" type="text", name="search-area", placeholder="поиск задач" value="{{ search_input }}">
            <input class="button"type="submit", value="Поиск">
        </form>
        {% if tasks|length > 0 %}
        <a id="add-link" href= "{% url 'task-create' %}">&#x2b;</a>
        {% endif %}
    </div>
    <div id="tasklist" class="task-items-wrapper">
        {% for task in tasks %}
        <div class="task-wrapper" data-position="{{task.pk}}">
            <div class="task-title">
                {% if task.complete %}
                    <div class="task-complete-icon"></div>
                    <s><a href="{% url 'task-update' task.id %}">{{task.title}}</a></s> 
                {% else %}
                    <div class="task-incomplete-icon"></div>
                    <a href="{% url 'task-update' task.id %}">{{task.title}}</a> 
                {% endif %}
            </div>
            <div class="task-controls">
                <a class="delete-link" href="{% url 'task-delete' task.id %}">&#215;</a>
                <span class="handle">&nbsp;&#10247;</span>
            </div>
        </div>

        {% empty %}
        <div style="text-align: center; padding-bottom: 10px; line-height: 1em;">
            <h3>У вас нету активных задач.</h3>
            <h3>Хотите создать <a style="text-decoration: none; color: #e53935;" href="{% url 'task-create' %}">Новое задание</a> ! </h3>
        </div>
        {% endfor %}
    </div>
</div>

<script>
$(document).ready(function () {
    $('#tasklist').sortable({
        handle: '.handle',
        opacity: 0.7,
        placeholder: 'placeholder',
        forcePlaceholderSize: true,
        stop: function (event, ui) {
            let rows = document.getElementsByClassName("task-wrapper");
            let task_order = [];
            for (let row of rows) {
                task_order.push(row.dataset.position);
            }
            $.ajax({
                type: "POST",
                url: "{% url 'task-reorder' %}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(task_order)
            });
        }
    });
});        
</script>

<script>
let page_num = 1;

$(window).scroll(function() {
    var margin = $(document).height() - $(window).height() - 200;
    if ($(window).scrollTop() > margin && page_num < {{ page_limit }}) {
        $.ajax({
            type: "GET",
            url: "{% url 'tasks' %}",
            data: {page: ++page_num},
            dataType: "html",
            success: function (data) {
                $("#tasklist").append(data).html()
            },
            //error: function (xhr, status) {
              //  alert("Sorry, there was a problem!");
            //},
            //complete: function (xhr, status) {
                //$('#').slideDown('slow')
            });
        }
    });
</script>

{% endblock content %}